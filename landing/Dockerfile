FROM node:14-alpine

RUN mkdir -p /home/node/app/node_modules && chown -R node:node /home/node/app


ARG API_ABSOLUTE
ARG FRONTEND_URL
ARG MERCADOPAGO_KEY
ARG PUSHER_APP_ID
ARG PUSHER_CLUSTER
ARG PUSHER_KEY
ARG PUSHER_SECRET
ARG VUE_APP_LANDING
ARG VUE_APP_PUSHER_BEAMS_INSTANCE
ARG VUE_APP_PUSHER_CLUSTER
ARG VUE_APP_PUSHER_KEY
ARG VUE_APP_URL

RUN export API_ABSOLUTE=$API_ABSOLUTE
RUN export FRONTEND_URL=$FRONTEND_URL
RUN export MERCADOPAGO_KEY=$MERCADOPAGO_KEY
RUN export PUSHER_APP_ID=$PUSHER_APP_ID
RUN export PUSHER_CLUSTER=$PUSHER_CLUSTER
RUN export PUSHER_KEY=$PUSHER_KEY
RUN export PUSHER_SECRET=$PUSHER_SECRET
RUN export VUE_APP_LANDING=$VUE_APP_LANDING
RUN export VUE_APP_PUSHER_BEAMS_INSTANCE=$VUE_APP_PUSHER_BEAMS_INSTANCE
RUN export VUE_APP_PUSHER_CLUSTER=$VUE_APP_PUSHER_CLUSTER
RUN export VUE_APP_PUSHER_KEY=$VUE_APP_PUSHER_KEY
RUN export VUE_APP_URL=$VUE_APP_URL

WORKDIR /home/node/app
ENV HOST=0.0.0.0
ENV PORT=8080
ENV NODE_ENV=production
USER node

COPY --chown=node:node . ./

RUN npm install
RUN npm run create-env
RUN npm run generate
EXPOSE 9000 8080

ENTRYPOINT ["npm", "run", "start"]