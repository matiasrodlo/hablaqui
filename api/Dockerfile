FROM node:14-alpine

ENV PYTHONUNBUFFERED=1
RUN apk add --update --no-cache python3 && ln -sf python3 /usr/bin/python
RUN python3 -m ensurepip
RUN pip3 install --no-cache --upgrade pip setuptools
RUN apk --no-cache add --virtual builds-deps build-base python3

RUN mkdir -p /home/node/app/node_modules && chown -R node:node /home/node/app

WORKDIR /home/node/app

ARG NODE_ENV=development
ARG NODE_PORT=3000
ARG API_URL
ARG BUCKETNAME
ARG FRONTEND_URL
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_REDIRECT
ARG GOOGLE_CLIENT_SECRET
ARG LANDING_URL
ARG MAILGUN_API_KEY
ARG MERCADOPAGO_KEY
ARG NO_REPLY_EMAIL
ARG NO_REPLY_PASSWORD
ARG PUSHER_APP_ID
ARG PUSHER_CLUSTER
ARG PUSHER_KEY
ARG PUSHER_SECRET
ARG VUE_APP_LANDING
ARG VUE_APP_PUSHER_BEAMS_INSTANCE
ARG VUE_APP_PUSHER_CLUSTER
ARG VUE_APP_PUSHER_KEY
ARG VUE_APP_URL
ARG URLDB
ARG SEGMENT_API_KEY
ARG SENDGRID_API_KEY

RUN export NODE_ENV=$NODE_ENV
RUN export NODE_PORT=$NODE_PORT
RUN export API_URL=$API_URL
RUN export BUCKETNAME=$BUCKETNAME
RUN export FRONTEND_URL=$FRONTEND_URL
RUN export GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
RUN export GOOGLE_CLIENT_REDIRECT=$GOOGLE_CLIENT_REDIRECT
RUN export GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
RUN export LANDING_URL=$LANDING_URL
RUN export MAILGUN_API_KEY=$MAILGUN_API_KEY
RUN export MERCADOPAGO_KEY=$MERCADOPAGO_KEY
RUN export NO_REPLY_EMAIL=$NO_REPLY_EMAIL
RUN export NO_REPLY_PASSWORD=$NO_REPLY_PASSWORD
RUN export PUSHER_APP_ID=$PUSHER_APP_ID
RUN export PUSHER_CLUSTER=$PUSHER_CLUSTER
RUN export PUSHER_KEY=$PUSHER_KEY
RUN export PUSHER_SECRET=$PUSHER_SECRET
RUN export VUE_APP_LANDING=$VUE_APP_LANDING
RUN export VUE_APP_PUSHER_BEAMS_INSTANCE=$VUE_APP_PUSHER_BEAMS_INSTANCE
RUN export VUE_APP_PUSHER_CLUSTER=$VUE_APP_PUSHER_CLUSTER
RUN export VUE_APP_PUSHER_KEY=$VUE_APP_PUSHER_KEY
RUN export VUE_APP_URL=$VUE_APP_URL
RUN export URLDB=$URLDB
RUN export SEGMENT_API_KEY=$SEGMENT_API_KEY
RUN export SENDGRID_API_KEY=$SENDGRID_API_KEY

USER node

COPY package.json ./
COPY server.js ./
COPY --chown=node:node /server ./server

RUN npm install
RUN npm rebuild bcrypt --build-from-source
RUN npm run create-env

EXPOSE 3000

ENTRYPOINT ["npm", "run", "container"]